<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chat Application</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-container {
      display: flex;
      height: 80vh;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    .conversation-list {
      width: 30%;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      background-color: #f8f9fa;
    }
    .chat-area {
      width: 70%;
      display: flex;
      flex-direction: column;
    }
    .messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
      background-color: #fff;
    }
    .message-input {
      padding: 15px;
      border-top: 1px solid #ddd;
      background-color: #f8f9fa;
    }
    .conversation-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    .conversation-item:hover {
      background-color: #e9ecef;
    }
    .conversation-item.active {
      background-color: #e9f7fe;
      border-left: 3px solid #0d6efd;
    }
    .message-sent {
      background-color: #d4edda;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 5px 0;
      max-width: 70%;
      align-self: flex-end;
    }
    .message-received {
      background-color: #f8f9fa;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 5px 0;
      max-width: 70%;
      align-self: flex-start;
      border: 1px solid #dee2e6;
    }
    .message-time {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 3px;
    }
    .conversation-name {
      font-weight: 500;
    }
    .no-conversation {
      color: #6c757d;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
<div class="container mt-3">
  <h2 class="text-center mb-4">Hệ thống Chat</h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <span class="fw-bold">Xin chào, </span>
      <span th:text="${currentUser.firstName + ' ' + currentUser.lastName}"></span>
    </div>
    <a th:href="@{/logout}" class="btn btn-sm btn-danger">Đăng xuất</a>
  </div>

  <div class="chat-container">
    <!-- Danh sách cuộc trò chuyện -->
    <div class="conversation-list">
      <div th:if="${conversations.empty}">
        <p class="no-conversation">Bạn chưa có cuộc trò chuyện nào</p>
      </div>
      <div th:each="conversation : ${conversations}"
           th:classappend="${selectedConversationId == conversation.id} ? 'conversation-item active' : 'conversation-item'"
           th:onclick="'selectConversation(' + ${conversation.id} + ')'">
        <div class="conversation-name">
          <span th:if="${currentUser instanceof T(com.scm.pojo.Teacher)}"
                th:text="${conversation.student.firstName + ' ' + conversation.student.lastName}"></span>
          <span th:unless="${currentUser instanceof T(com.scm.pojo.Teacher)}"
                th:text="${conversation.teacher.firstName + ' ' + conversation.teacher.lastName}"></span>
        </div>
      </div>
    </div>

    <!-- Khu vực chat -->
    <div class="chat-area" th:if="${selectedConversationId != null}">
      <div class="messages" id="messageArea">
        <!-- Tin nhắn sẽ được thêm vào đây bằng JavaScript -->
      </div>
      <div class="message-input d-flex">
        <input type="text" id="messageInput" class="form-control me-2" placeholder="Nhập tin nhắn...">
        <button onclick="sendMessage()" class="btn btn-primary">Gửi</button>
      </div>
    </div>

    <div class="chat-area d-flex align-items-center justify-content-center" th:unless="${selectedConversationId != null}">
      <div class="text-center">
        <i class="bi bi-chat-left-text" style="font-size: 2rem; color: #6c757d;"></i>
        <p class="mt-2">Vui lòng chọn một cuộc trò chuyện để bắt đầu</p>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="currentUserId" th:value="${currentUser.id}">
<input type="hidden" id="selectedConversationId" th:value="${selectedConversationId}">

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  var stompClient = null;
  var currentUserId = document.getElementById('currentUserId').value;
  var selectedConversationId = document.getElementById('selectedConversationId').value;

  function connect() {
    var socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);

      // Subscribe to personal message queue
      stompClient.subscribe('/user/queue/messages', function(message) {
        showMessage(JSON.parse(message.body));
      });

      // Load previous messages if conversation is selected
      if (selectedConversationId && selectedConversationId !== 'null') {
        loadMessages(selectedConversationId);
      }
    });
  }

  function selectConversation(conversationId) {
    // Get current path without query parameters
    var basePath = window.location.pathname;
    window.location.href = basePath + '?conversationId=' + conversationId;
  }

  function loadMessages(conversationId) {
    fetch('/ScoreManagement/messages?conversationId=' + conversationId) // Sửa URL này
            .then(response => response.json())
            .then(messages => {
              const messageArea = document.getElementById('messageArea');
              messageArea.innerHTML = '';

              messages.forEach(message => {
                showMessage(message);
              });

              messageArea.scrollTop = messageArea.scrollHeight;
            })
            .catch(error => console.error('Error:', error));
  }

  function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const content = messageInput.value.trim();

    if (content && selectedConversationId && selectedConversationId !== 'null') {
      const message = {
        conversationId: { id: parseInt(selectedConversationId) },
        message: content,
        sender: { id: parseInt(currentUserId) }
      };

      stompClient.send("/app/chat.private." + selectedConversationId, {}, JSON.stringify(message));
      messageInput.value = '';
    }
  }

  function showMessage(message) {
    const messageArea = document.getElementById('messageArea');
    const messageElement = document.createElement('div');
    const timeElement = document.createElement('div');

    // Format time
    const messageTime = new Date(message.createdDate || new Date());
    const timeString = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    timeElement.className = 'message-time';
    timeElement.textContent = timeString;

    if (message.sender.id == currentUserId) {
      messageElement.className = 'message-sent';
      messageElement.innerHTML = message.message;
    } else {
      messageElement.className = 'message-received';
      messageElement.innerHTML = '<strong>' + message.sender.firstName + ':</strong> ' + message.message;
    }

    messageElement.appendChild(timeElement);
    messageArea.appendChild(messageElement);
    messageArea.scrollTop = messageArea.scrollHeight;
  }

  // Connect when page loads
  window.onload = connect;

  // Handle Enter key press
  document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  /*]]>*/
</script>
</body>
</html>